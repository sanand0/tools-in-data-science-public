<!-- Explicit dark/light toggle in sidebar.
     `BookTheme` stays `auto`; this adds user override persisted in localStorage. -->
<button id="tds-theme-toggle" class="tds-theme-toggle" type="button" aria-label="Toggle dark and light mode">◐ Theme</button>
<script>
  (function () {
    var btn = document.getElementById("tds-theme-toggle");
    if (!btn) return;

    var getTheme = function () {
      var saved = localStorage.getItem("tds-theme");
      if (saved === "light" || saved === "dark") return saved;
      return "dark";
    };

    var applyTheme = function (theme) {
      document.documentElement.setAttribute("data-user-theme", theme);
      localStorage.setItem("tds-theme", theme);
      btn.textContent = theme === "dark" ? "☀ Light Mode" : "☾ Dark Mode";
    };

    applyTheme(getTheme());
    btn.addEventListener("click", function () {
      var now = document.documentElement.getAttribute("data-user-theme");
      applyTheme(now === "dark" ? "light" : "dark");
    });
  })();

  (function () {
    var normalize = function (p) {
      if (!p) return "/";
      p = p.split("#")[0].split("?")[0];
      if (p.length > 1 && p.endsWith("/")) p = p.slice(0, -1);
      return p || "/";
    };

    var current = normalize(window.location.pathname);
    document.querySelectorAll(".book-menu-content a[href]").forEach(function (a) {
      var href = a.getAttribute("href") || "";
      if (!href.startsWith("/")) return;
      if (normalize(href) === current) {
        a.classList.add("active");
        a.setAttribute("aria-current", "page");
      }
    });
  })();
</script>
